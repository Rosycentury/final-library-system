<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="'编辑《' + ${book.title} + '》'">编辑图书</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #3498db;
            --warning-color: #f39c12;
        }
        
        .edit-book-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .form-header {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .form-body {
            padding: 30px;
        }
        
        .form-label {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 8px;
        }
        
        .form-control, .form-select {
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            padding: 12px 15px;
            transition: all 0.3s;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--warning-color);
            box-shadow: 0 0 0 0.2rem rgba(243, 156, 18, 0.25);
        }
        
        .form-text {
            color: #7f8c8d;
            font-size: 0.85rem;
        }
        
        .required-star {
            color: #e74c3c;
        }
        
        .btn-update {
            background: linear-gradient(135deg, var(--warning-color) 0%, #d35400 100%);
            border: none;
            color: white;
            padding: 12px 30px;
            font-weight: 600;
            border-radius: 10px;
            transition: all 0.3s;
        }
        
        .btn-update:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        
        .btn-cancel {
            background: #95a5a6;
            border: none;
            color: white;
            padding: 12px 30px;
            font-weight: 600;
            border-radius: 10px;
            transition: all 0.3s;
        }
        
        .btn-cancel:hover {
            background: #7f8c8d;
        }
        
        .preview-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .preview-title {
            color: #2c3e50;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .preview-item {
            margin-bottom: 10px;
        }
        
        .preview-label {
            font-weight: bold;
            color: #7f8c8d;
            width: 100px;
            display: inline-block;
        }
        
        .preview-value {
            color: #2c3e50;
        }
        
        .warning-alert {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .update-history {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        
        .history-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 10px 15px;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <div th:replace="fragments/navbar :: navbar"></div>

    <!-- 消息提示 -->
    <div th:replace="fragments/navbar :: messages"></div>

    <!-- 主要内容 -->
    <div class="container-fluid mt-4">
        <!-- 返回链接 -->
        <div class="mb-4">
            <a th:href="@{'/books/' + ${book.id}}" class="text-decoration-none text-primary">
                <i class="fas fa-arrow-left me-2"></i>返回图书详情
            </a>
        </div>
        
        <!-- 权限检查 -->
        <div th:unless="${session.role == 'ADMIN'}" class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>
            您没有权限编辑图书，请以管理员身份登录。
        </div>
        
        <div th:if="${session.role == 'ADMIN'}">
            <div th:if="${book == null}" class="alert alert-danger">
                图书不存在或已被删除。
            </div>
            
            <div th:unless="${book == null}">
                <div class="edit-book-container">
                    <!-- 表单头部 -->
                    <div class="form-header">
                        <h2><i class="fas fa-edit me-2"></i>编辑图书信息</h2>
                        <p class="mb-0">正在编辑：<span th:text="${book.title}"></span></p>
                    </div>
                    
                    <!-- 预览区域 -->
                    <div class="preview-section">
                        <h5 class="preview-title">
                            <i class="fas fa-eye me-2"></i>当前信息预览
                        </h5>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="preview-item">
                                    <span class="preview-label">书名：</span>
                                    <span class="preview-value" th:text="${book.title}"></span>
                                </div>
                                <div class="preview-item">
                                    <span class="preview-label">作者：</span>
                                    <span class="preview-value" th:text="${book.author}"></span>
                                </div>
                                <div class="preview-item">
                                    <span class="preview-label">ISBN：</span>
                                    <span class="preview-value" th:text="${book.isbn}"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="preview-item">
                                    <span class="preview-label">总数量：</span>
                                    <span class="preview-value" th:text="${book.totalCopies}"></span>
                                </div>
                                <div class="preview-item">
                                    <span class="preview-label">可借数量：</span>
                                    <span class="preview-value" th:text="${book.availableCopies}"></span>
                                </div>
                                <div class="preview-item">
                                    <span class="preview-label">最后更新：</span>
                                    <span class="preview-value" 
                                          th:text="${#temporals.format(book.updateTime, 'yyyy-MM-dd HH:mm')}"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 警告提示 -->
                    <div class="warning-alert">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>注意：</strong>修改图书信息可能会影响现有的借阅记录，请谨慎操作。
                    </div>
                    
                    <!-- 编辑表单 -->
                    <form th:action="@{'/books/' + ${book.id} + '/edit'}" method="post" id="editBookForm" class="form-body">
                        <input type="hidden" name="id" th:value="${book.id}">
                        
                        <!-- 基本信息 -->
                        <h5 class="mb-4"><i class="fas fa-info-circle me-2"></i>基本信息</h5>
                        
                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <label for="title" class="form-label">
                                    书名<span class="required-star">*</span>
                                </label>
                                <input type="text" class="form-control" id="title" name="title" 
                                       th:value="${book.title}" required maxlength="200">
                                <div class="form-text">请输入完整的书名</div>
                            </div>
                            
                            <div class="col-md-6 mb-4">
                                <label for="author" class="form-label">
                                    作者<span class="required-star">*</span>
                                </label>
                                <input type="text" class="form-control" id="author" name="author" 
                                       th:value="${book.author}" required maxlength="100">
                                <div class="form-text">可输入多位作者，用逗号分隔</div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <label for="isbn" class="form-label">
                                    ISBN<span class="required-star">*</span>
                                </label>
                                <input type="text" class="form-control" id="isbn" name="isbn" 
                                       th:value="${book.isbn}" required pattern="\d{3}-\d-\d{3}-\d{5}-\d">
                                <div class="form-text">格式：XXX-X-XXX-XXXXX-X（13位）</div>
                            </div>
                            
                            <div class="col-md-6 mb-4">
                                <label for="publisher" class="form-label">出版社</label>
                                <input type="text" class="form-control" id="publisher" name="publisher" 
                                       th:value="${book.publisher}" maxlength="100">
                                <div class="form-text">例如：机械工业出版社</div>
                            </div>
                        </div>
                        
                        <!-- 库存信息 -->
                        <h5 class="mb-4 mt-5"><i class="fas fa-boxes me-2"></i>库存信息</h5>
                        
                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <label for="totalCopies" class="form-label">
                                    总数量<span class="required-star">*</span>
                                </label>
                                <input type="number" class="form-control" id="totalCopies" 
                                       name="totalCopies" th:value="${book.totalCopies}" 
                                       min="1" max="1000" required>
                                <div class="form-text">图书馆拥有的总本数</div>
                            </div>
                            
                            <div class="col-md-6 mb-4">
                                <label for="availableCopies" class="form-label">
                                    可借数量<span class="required-star">*</span>
                                </label>
                                <input type="number" class="form-control" id="availableCopies" 
                                       name="availableCopies" th:value="${book.availableCopies}" 
                                       min="0" th:max="${book.totalCopies}" required>
                                <div class="form-text">不能超过总数量，当前可借数：<span th:text="${book.availableCopies}"></span></div>
                            </div>
                        </div>
                        
                        <!-- 其他信息 -->
                        <h5 class="mb-4 mt-5"><i class="fas fa-file-alt me-2"></i>其他信息</h5>
                        
                        <div class="mb-4">
                            <label for="category" class="form-label">分类</label>
                            <select class="form-select" id="category" name="category">
                                <option value="">请选择分类</option>
                                <option value="文学">文学</option>
                                <option value="科技">科技</option>
                                <option value="历史">历史</option>
                                <option value="哲学">哲学</option>
                                <option value="经济">经济</option>
                                <option value="艺术">艺术</option>
                                <option value="教育">教育</option>
                                <option value="其他">其他</option>
                            </select>
                        </div>
                        
                        <div class="mb-4">
                            <label for="description" class="form-label">图书简介</label>
                            <textarea class="form-control" id="description" name="description" 
                                      rows="4" placeholder="请输入图书简介" maxlength="1000"></textarea>
                            <div class="form-text">不超过1000字</div>
                        </div>
                        
                        <div class="mb-4">
                            <label for="location" class="form-label">存放位置</label>
                            <input type="text" class="form-control" id="location" name="location" 
                                   placeholder="例如：A区3排2架" maxlength="50">
                            <div class="form-text">图书在图书馆中的具体位置</div>
                        </div>
                        
                        <!-- 更新历史（示例） -->
                        <div class="update-history">
                            <h6><i class="fas fa-history me-2"></i>更新历史</h6>
                            <div class="history-item">
                                <i class="fas fa-plus-circle text-success me-2"></i>
                                2024-01-01 10:30:00 - 图书创建
                            </div>
                            <div class="history-item">
                                <i class="fas fa-edit text-warning me-2"></i>
                                2024-01-15 14:20:00 - 更新库存信息
                            </div>
                        </div>
                        
                        <!-- 表单按钮 -->
                        <div class="d-flex justify-content-between mt-5">
                            <a th:href="@{'/books/' + ${book.id}}" class="btn btn-cancel">
                                <i class="fas fa-times me-2"></i>取消
                            </a>
                            <button type="submit" class="btn btn-update">
                                <i class="fas fa-save me-2"></i>保存更改
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 页脚 -->
    <div th:replace="fragments/navbar :: footer"></div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- 自定义脚本 -->
    <script>
        // 表单验证
        document.getElementById('editBookForm').addEventListener('submit', function(e) {
            const title = document.getElementById('title');
            const author = document.getElementById('author');
            const isbn = document.getElementById('isbn');
            const totalCopies = document.getElementById('totalCopies');
            const availableCopies = document.getElementById('availableCopies');
            let isValid = true;
            
            // 验证必填项
            if (!title.value.trim()) {
                showError(title, '书名不能为空');
                isValid = false;
            } else {
                clearError(title);
            }
            
            if (!author.value.trim()) {
                showError(author, '作者不能为空');
                isValid = false;
            } else {
                clearError(author);
            }
            
            if (!isbn.value.trim()) {
                showError(isbn, 'ISBN不能为空');
                isValid = false;
            } else if (!validateISBN(isbn.value)) {
                showError(isbn, 'ISBN格式不正确');
                isValid = false;
            } else {
                clearError(isbn);
            }
            
            // 验证数量
            const total = parseInt(totalCopies.value);
            const available = parseInt(availableCopies.value);
            
            if (total < 1) {
                showError(totalCopies, '总数量必须大于0');
                isValid = false;
            } else {
                clearError(totalCopies);
            }
            
            if (available < 0) {
                showError(availableCopies, '可借数量不能为负数');
                isValid = false;
            } else if (available > total) {
                showError(availableCopies, '可借数量不能超过总数量');
                isValid = false;
            } else {
                clearError(availableCopies);
            }
            
            if (!isValid) {
                e.preventDefault();
                
                // 滚动到第一个错误处
                const firstError = document.querySelector('.is-invalid');
                if (firstError) {
                    firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    firstError.focus();
                }
            }
        });
        
        // ISBN验证
        function validateISBN(isbn) {
            const cleaned = isbn.replace(/-/g, '');
            return /^\d{13}$/.test(cleaned);
        }
        
        // 显示错误
        function showError(input, message) {
            const formGroup = input.closest('.mb-4');
            const errorDiv = formGroup.querySelector('.error-message') || document.createElement('div');
            errorDiv.className = 'error-message text-danger mt-1 small';
            errorDiv.textContent = message;
            
            if (!formGroup.querySelector('.error-message')) {
                formGroup.appendChild(errorDiv);
            }
            
            input.classList.add('is-invalid');
            input.classList.remove('is-valid');
        }
        
        // 清除错误
        function clearError(input) {
            const formGroup = input.closest('.mb-4');
            const errorDiv = formGroup.querySelector('.error-message');
            if (errorDiv) {
                errorDiv.remove();
            }
            
            input.classList.remove('is-invalid');
            input.classList.add('is-valid');
        }
        
        // 自动关闭警告框
        setTimeout(function() {
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(alert => {
                const bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            });
        }, 5000);
        
        // 可借数量最大值动态更新
        document.getElementById('totalCopies').addEventListener('input', function() {
            const total = parseInt(this.value);
            const availableInput = document.getElementById('availableCopies');
            if (!isNaN(total) && total > 0) {
                availableInput.max = total;
                if (parseInt(availableInput.value) > total) {
                    availableInput.value = total;
                }
            }
        });
    </script>
</body>
</html>